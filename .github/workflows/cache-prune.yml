name: Cache Prune

on:
  workflow_dispatch: {}
  schedule:
    - cron: '17 3 * * *'

permissions:
  actions: write
  contents: write

env:
  BILLING_RELEASE_TAG: 'billing-state-v1'

jobs:
  prune:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Verify GitHub CLI
        run: gh --version

      - name: Download billing-state cache_index
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p .billing-state
          gh release download "${BILLING_RELEASE_TAG}" -D .billing-state -p 'cache_index.csv'

      - name: Cache prune
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          python -m platform.cli cache-prune --billing-state-dir .billing-state

      - name: Upload updated cache index
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh release upload "${BILLING_RELEASE_TAG}" .billing-state/cache_index.csv --clobber
