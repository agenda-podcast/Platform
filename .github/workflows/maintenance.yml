name: Maintenance

on:
  push:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  maintenance:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.cpr.outputs.pull-request-number }}
      pr_url: ${{ steps.cpr.outputs.pull-request-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi
          if [ -f pyproject.toml ] || [ -f setup.py ]; then
            python -m pip install -e .
          fi

      - name: Publish script guardrail (no-publish)
        shell: bash
        run: |
          set -euo pipefail

          rm -rf dist_artifacts_guardrail
          rm -rf runtime-guardrail
          mkdir -p runtime-guardrail

          rc=0
          python scripts/publish_artifacts_release.py \
            --runtime-profile config/runtime_profile.dev_github.yml \
            --billing-state-dir billing-state-seed \
            --runtime-dir runtime-guardrail \
            --dist-dir dist_artifacts_guardrail \
            --since 2100-01-01T00:00:00Z \
            --no-publish || rc=$?

          if [ "$rc" -ne 0 ] && [ "$rc" -ne 2 ]; then
            echo "[GUARDRAIL][FAIL] publish_artifacts_release.py returned unexpected code: $rc" >&2
            exit "$rc"
          fi

          test -d dist_artifacts_guardrail

      - name: Run Maintenance
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BILLING_TAG: billing-state-v1
          BILLING_TEMPLATE_DIR: releases/billing-state-v1
          BILLING_STATE_DIR: .billing-state
        run: |
          set -euo pipefail
          bash scripts/run_maintenance.sh

      - name: Regenerate Verify dropdowns from maintenance-state indexes
        shell: bash
        run: |
          set -euo pipefail
          python scripts/maintenance_regen_verify_dropdowns.py

      - name: Verify repository invariants (modules/tenants/maintenance-state)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/ci_verify.py --phase pre

      - name: Create PR for regenerated files (no direct push)
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(maintenance): refresh generated files [skip ci]"
          committer: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          title: "Maintenance: refresh generated files"
          body: |
            Automated maintenance regeneration produced changes.

            Source run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          branch: "maintenance/regen-${{ github.run_id }}"
          base: main
          labels: |
            maintenance-auto
          add-paths: |
            maintenance-state
            platform/secretstore/secretstore.template.json
            .github/workflows/verify_modules.yml
            .github/workflows/verify_workorders.yml

      - name: Report PR outcome
        shell: bash
        run: |
          set -euo pipefail
          pr_number="${{ steps.cpr.outputs.pull-request-number }}"
          pr_url="${{ steps.cpr.outputs.pull-request-url }}"

          if [ -z "$pr_number" ]; then
            echo "[MAINTENANCE] No changes detected. No PR created."
            exit 0
          fi

          echo "[MAINTENANCE] Opened PR #$pr_number: $pr_url"

      - name: Verify local billing-state bootstrap (headers + ID format)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/ci_verify.py --phase post --billing-state-dir .billing-state

  maintenance_commit:
    name: Maintenance Commit (called)
    needs: maintenance
    if: ${{ needs.maintenance.outputs.pr_number != '' }}
    uses: ./.github/workflows/maintenance_commit.yml
    secrets: inherit
    with:
      pr_number: ${{ needs.maintenance.outputs.pr_number }}

  verify_platform:
    name: Verify Platform (called)
    needs: maintenance
    uses: ./.github/workflows/verify_platform.yml
    secrets: inherit
    permissions:
      contents: read
