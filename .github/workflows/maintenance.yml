name: Maintenance

on:
  push:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

  issues: write
jobs:
  maintenance:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.WORKFLOW_PUSH_TOKEN }}
          fetch-depth: 0
      - name: Ensure billing-state release + bootstrap local billing-state
        shell: bash
        run: |
          set -euo pipefail
          python -m platform.maintenance.main

      - name: Regenerate maintenance-state derived indexes
        shell: bash
        run: |
          set -euo pipefail
          python scripts/maintenance_regen_verify_dropdowns.py

      - name: CI verify
        shell: bash
        run: |
          set -euo pipefail
          python scripts/ci_verify.py --phase post

      - name: Detect changes (dirty working tree)
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          echo "[MAINTENANCE] git status --porcelain:"
          git status --porcelain || true
          if [ -n "$(git status --porcelain)" ]; then
            echo "[MAINTENANCE] Working tree is DIRTY. PR will be created."
            echo "dirty=true" >> "$GITHUB_OUTPUT"
            echo "[MAINTENANCE] diffstat:"
            git diff --stat || true
          else
            echo "[MAINTENANCE] Working tree is CLEAN. No PR needed."
            echo "dirty=false" >> "$GITHUB_OUTPUT"
          fi


      - name: "Ensure label exists: maintenance-auto"
        if: steps.detect.outputs.dirty == 'true'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PUSH_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "[MAINTENANCE] Ensuring label exists: maintenance-auto"
          if gh label list --json name -q '.[].name' | grep -qx 'maintenance-auto'; then
            echo "[MAINTENANCE] Label already exists: maintenance-auto"
            exit 0
          fi
          gh label create 'maintenance-auto' --color '1D76DB' --description 'Autogenerated maintenance regeneration PRs'
          echo "[MAINTENANCE] Label created: maintenance-auto"

      - name: Create PR (never push to main)
        if: steps.detect.outputs.dirty == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.WORKFLOW_PUSH_TOKEN }}
          branch: maintenance/regen-${{ github.run_id }}
          base: main
          title: "maintenance: regenerate"
          commit-message: "maintenance: regenerate"
          body: Autogenerated maintenance regeneration.
          labels: |
            maintenance-auto
          delete-branch: false

      - name: Debug PR resolution
        if: steps.detect.outputs.dirty == 'true'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PUSH_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "[MAINTENANCE][DEBUG] cpr.operation=${{ steps.cpr.outputs.pull-request-operation }}"
          echo "[MAINTENANCE][DEBUG] cpr.number=${{ steps.cpr.outputs.pull-request-number }}"
          echo "[MAINTENANCE][DEBUG] cpr.url=${{ steps.cpr.outputs.pull-request-url }}"
          REPO="${{ github.repository }}"
          HEAD_BRANCH="maintenance/regen-${{ github.run_id }}"
          echo "[MAINTENANCE][DEBUG] gh pr list for head=${HEAD_BRANCH}"
          gh pr list --repo "${REPO}" --state open --base main --head "${HEAD_BRANCH}" --json number,url,headRefName,baseRefName -q '.[] | "#\(.number) \(.url) head=\(.headRefName) base=\(.baseRefName)"'
      - name: Report PR outcome
        if: steps.detect.outputs.dirty == 'true'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PUSH_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "[MAINTENANCE] pull-request-operation=${{ steps.cpr.outputs.pull-request-operation }}"
          echo "[MAINTENANCE] pull-request-number=${{ steps.cpr.outputs.pull-request-number }}"
          echo "[MAINTENANCE] pull-request-url=${{ steps.cpr.outputs.pull-request-url }}"

          head_branch="maintenance/regen-${{ github.run_id }}"
          pr_number="${{ steps.cpr.outputs.pull-request-number }}"

          if [ -z "${pr_number}" ]; then
            echo "[MAINTENANCE][WARN] create-pull-request did not return a PR number. Resolving via gh." 
            pr_number="$(gh pr list --repo "${{ github.repository }}" --state open --base main --head "${head_branch}" --json number -q '.[0].number' || true)"
          fi

          if [ -z "${pr_number}" ]; then
            echo "[MAINTENANCE][FAIL] Working tree was dirty but no PR was created or resolved for head=${head_branch}."
            exit 1
          fi

          pr_url="$(gh pr view "${pr_number}" --repo "${{ github.repository }}" --json url -q .url)"
          echo "[MAINTENANCE][OK] PR #${pr_number}: ${pr_url}"
      - name: Merge maintenance PR to main (auto)
        if: steps.detect.outputs.dirty == 'true'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PUSH_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          HEAD_BRANCH="maintenance/regen-${{ github.run_id }}"
          PR_NUMBER="${{ steps.cpr.outputs.pull-request-number }}"
          if [ -z "${PR_NUMBER}" ]; then
            echo "[MAINTENANCE][WARN] create-pull-request did not return a PR number. Resolving via gh."
            PR_NUMBER="$(gh pr list --repo "${REPO}" --state open --base main --head "${HEAD_BRANCH}" --json number -q '.[0].number' || true)"
          fi
          if [ -z "${PR_NUMBER}" ]; then
            echo "[MAINTENANCE][FAIL] Could not resolve PR number for head=${HEAD_BRANCH}."
            exit 1
          fi
          echo "[MAINTENANCE] Attempting to enable auto-merge for PR #${PR_NUMBER}"
          set +e
          gh pr merge "${PR_NUMBER}" --repo "${REPO}" --auto --merge --delete-branch
          rc=$?
          set -e
          if [ $rc -eq 0 ]; then
            echo "[MAINTENANCE][OK] Auto-merge enabled for PR #${PR_NUMBER}"
            exit 0
          fi
          echo "[MAINTENANCE][WARN] Auto-merge enable failed (rc=${rc}). Trying immediate merge."
          echo "[MAINTENANCE][WARN] If this fails, enable Auto-merge in repo settings or adjust branch protection to allow merges by PAT."
          gh pr merge "${PR_NUMBER}" --repo "${REPO}" --merge --delete-branch
