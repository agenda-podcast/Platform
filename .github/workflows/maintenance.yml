name: Maintenance

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: maintenance-main
  cancel-in-progress: false

jobs:
  maintenance:
    # Prevent infinite loops when Maintenance pushes a commit to main.
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # APPLY mode: repo is allowed to be non-canonical on merge;
      # Maintenance must converge it (rename/merge folders, backfill registries/prices, etc.).
      - name: Run Maintenance (apply)
        run: |
          set -euxo pipefail
          python scripts/maintenance_repo.py

      # After apply, the repo MUST be canonical and idempotent.
      - name: Maintenance idempotency check
        run: |
          set -euxo pipefail
          python scripts/maintenance_repo.py --check

      - name: Commit maintenance outputs (if any)
        run: |
          set -euxo pipefail
          if [ -z "$(git status --porcelain)" ]; then
            echo "No maintenance changes to commit."
            exit 0
          fi
          git add -A
          git commit -m "Maintenance: canonicalize repo and backfill registries/prices"
          git push

  e2e:
    name: E2E Verification
    needs: maintenance
    runs-on: ubuntu-latest
    steps:
      # IMPORTANT: checkout latest main (including any commit pushed by maintenance job).
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Verify repo is canonical (post-maintenance)
        run: |
          set -euxo pipefail
          python scripts/maintenance_repo.py --check

      - name: CI Verify (pre)
        run: |
          set -euxo pipefail
          python scripts/ci_verify.py             --phase pre             --billing-state-dir .billing-state-ci             --runtime-dir runtime

      - name: Orchestrate
        run: |
          set -euxo pipefail
          python -m platform.cli orchestrate             --runtime-dir runtime             --billing-state-dir .billing-state-ci

      - name: CI Verify (post)
        run: |
          set -euxo pipefail
          python scripts/ci_verify.py             --phase post             --billing-state-dir .billing-state-ci             --runtime-dir runtime
