name: Maintenance

on:
  push:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  maintenance:
    if: ${{ github.actor != 'github-actions[bot]' }}
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.prresolve.outputs.pr_number }}
      pr_url: ${{ steps.prresolve.outputs.pr_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi
          if [ -f pyproject.toml ] || [ -f setup.py ]; then
            python -m pip install -e .
          fi

      - name: Publish script guardrail (no-publish)
        shell: bash
        run: |
          set -euo pipefail

          rm -rf dist_artifacts_guardrail
          rm -rf runtime-guardrail
          mkdir -p runtime-guardrail

          rc=0
          python scripts/publish_artifacts_release.py \
            --runtime-profile config/runtime_profile.dev_github.yml \
            --billing-state-dir billing-state-seed \
            --runtime-dir runtime-guardrail \
            --dist-dir dist_artifacts_guardrail \
            --since 2100-01-01T00:00:00Z \
            --no-publish || rc=$?

          if [ "$rc" -ne 0 ] && [ "$rc" -ne 2 ]; then
            echo "[GUARDRAIL][FAIL] publish_artifacts_release.py returned unexpected code: $rc" >&2
            exit "$rc"
          fi

          test -d dist_artifacts_guardrail

      - name: Run Maintenance
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
          BILLING_TAG: billing-state-v1
          BILLING_TEMPLATE_DIR: releases/billing-state-v1
          BILLING_STATE_DIR: .billing-state
        run: |
          set -euo pipefail
          bash scripts/run_maintenance.sh

      - name: Regenerate Verify dropdowns from maintenance-state indexes
        shell: bash
        run: |
          set -euo pipefail
          python scripts/maintenance_regen_verify_dropdowns.py

      - name: Verify repository invariants (modules/tenants/maintenance-state)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/ci_verify.py --phase pre


      - name: Cleanup non-repo runtime logs (do not PR)
        shell: bash
        run: |
          set -euo pipefail
          rm -f billing-state-seed/deliverable_artifacts_log.csv
          rm -f billing-state-seed/outputs_log.csv
          rm -f billing-state-seed/published_artifacts_log.csv


      - name: Detect changes (dirty working tree)
        id: changes
        shell: bash
        run: |
          set -euo pipefail
          echo "[MAINTENANCE] git status --porcelain:"
          git status --porcelain || true
          if [ -n "$(git status --porcelain)" ]; then
            echo "dirty=true" >> "$GITHUB_OUTPUT"
            echo "[MAINTENANCE] Working tree is DIRTY. PR will be created."
            echo "[MAINTENANCE] diffstat:"
            git diff --stat || true
          else
            echo "dirty=false" >> "$GITHUB_OUTPUT"
            echo "[MAINTENANCE] Working tree is CLEAN. No PR will be created."
          fi

      - name: Ensure maintenance-auto label exists
        if: ${{ steps.changes.outputs.dirty == 'true' }}
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          label_name="maintenance-auto"
          echo "[MAINTENANCE] Ensuring label exists: ${label_name}"
          existing="$(gh label list --json name -q ".[] | select(.name == \"${label_name}\") | .name" || true)"
          if [ "${existing}" = "${label_name}" ]; then
            echo "[MAINTENANCE] Label already exists: ${label_name}"
            exit 0
          fi
          gh label create "${label_name}" --color "1D76DB" --description "Autogenerated maintenance regeneration PRs"
          echo "[MAINTENANCE] Label created: ${label_name}"

      - name: Create PR for regenerated files (no direct push)
        id: cpr
        if: ${{ steps.changes.outputs.dirty == 'true' }}
        continue-on-error: true
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          commit-message: "chore(maintenance): refresh generated files [skip ci]"
          committer: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          title: "Maintenance: refresh generated files"
          body: |
            Automated maintenance regeneration produced changes.

            Source run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          branch: "maintenance/regen-${{ github.run_id }}"
          base: main
          labels: |
            maintenance-auto

      - name: Report PR outcome
        if: ${{ steps.changes.outputs.dirty == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "[MAINTENANCE] create-pull-request conclusion=${{ steps.cpr.conclusion }} outcome=${{ steps.cpr.outcome }}"
          echo "[MAINTENANCE] Report PR outcome step running"
          echo '[MAINTENANCE] Report PR outcome step starting'
          op="${{ steps.cpr.outputs.pull-request-operation }}"
          pr_number="${{ steps.cpr.outputs.pull-request-number }}"
          pr_url="${{ steps.cpr.outputs.pull-request-url }}"
          pr_branch="${{ steps.cpr.outputs.pull-request-branch }}"
          pr_head_sha="${{ steps.cpr.outputs.pull-request-head-sha }}"

          if [ -z "$pr_number" ]; then
            echo "[MAINTENANCE][FAIL] Working tree was dirty but create-pull-request did not return a PR number." >&2
            echo "[MAINTENANCE][FAIL] operation=$op branch=$pr_branch head_sha=$pr_head_sha" >&2
            echo "[MAINTENANCE][FAIL] This usually means the PR API call failed, the token was not allowed to open PRs, or an organization policy blocked PR creation." >&2
            echo "[MAINTENANCE][FAIL] Next step will attempt to resolve PR via gh; if still missing, the job will fail." >&2
          fi

          if [ -n "$pr_number" ]; then
            echo "[MAINTENANCE] PR operation=$op"
            echo "[MAINTENANCE] Opened/Updated PR #$pr_number: $pr_url"
            echo "[MAINTENANCE] PR branch=$pr_branch head_sha=$pr_head_sha"
          fi

      - name: Resolve PR number (authoritative)
        id: prresolve
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          DIRTY: ${{ steps.changes.outputs.dirty }}
        run: |
          set -euo pipefail
          echo "[MAINTENANCE] gh version: $(gh --version | head -n 1)"
          echo "[MAINTENANCE] gh auth status (sanitized)"
          gh auth status -h github.com || true
          echo "[MAINTENANCE] Resolve PR step starting"
          echo "[MAINTENANCE] Resolve PR step running DIRTY=${DIRTY:-}"
          echo '[MAINTENANCE] Resolve PR step starting'

          if [ "${DIRTY:-}" != "true" ]; then
            {
              echo "pr_number="
              echo "pr_url="
              echo "pr_branch="
              echo "pr_operation="
            } >> "$GITHUB_OUTPUT"
            echo "[MAINTENANCE] Working tree was clean. No PR to resolve."
            exit 0
          fi

          branch="${{ steps.cpr.outputs.pull-request-branch }}"
          if [ -z "$branch" ]; then
            branch="maintenance/regen-${{ github.run_id }}"
          fi

          pr_number="${{ steps.cpr.outputs.pull-request-number }}"
          pr_url="${{ steps.cpr.outputs.pull-request-url }}"
          op="${{ steps.cpr.outputs.pull-request-operation }}"

          if [ -z "$pr_number" ]; then
            pr_number="$(gh pr list --head "$branch" --state open --json number --jq '.[0].number' || true)"
            pr_url="$(gh pr list --head "$branch" --state open --json url --jq '.[0].url' || true)"
          fi

          if [ -z "$pr_number" ]; then
            echo "[MAINTENANCE][WARN] create-pull-request did not return a PR. Attempting to create or reopen PR via gh." >&2

            any_number="$(gh pr list --head "$branch" --state all --json number --jq '.[0].number' || true)"
            any_state="$(gh pr list --head "$branch" --state all --json state --jq '.[0].state' || true)"
            any_url="$(gh pr list --head "$branch" --state all --json url --jq '.[0].url' || true)"

            if [ -n "$any_number" ] && [ "${any_state:-}" != "OPEN" ]; then
              echo "[MAINTENANCE] Found existing PR #$any_number in state=$any_state. Reopening." >&2
              gh pr reopen "$any_number" || true
            fi

            pr_number="$(gh pr list --head "$branch" --state open --json number --jq '.[0].number' || true)"
            pr_url="$(gh pr list --head "$branch" --state open --json url --jq '.[0].url' || true)"

            if [ -z "$pr_number" ]; then
              echo "[MAINTENANCE] No existing open PR. Creating a new PR via gh." >&2
              run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              body_file="$(mktemp)"
              printf '%s\n\n%s\n' \
                'Automated maintenance regeneration produced changes.' \
                'Source run: ${run_url}' > "$body_file"
              set +e
              gh_out="$(mktemp)"
              gh_err="$(mktemp)"
              gh pr create \
                --base main \
                --head "$branch" \
                --title "Maintenance: refresh generated files" \
                --body-file "$body_file" \
                --label maintenance-auto \
                >"$gh_out" 2>"$gh_err"
              gh_rc=$?
              set -e
              echo "[MAINTENANCE] gh pr create exit_code=$gh_rc"
              echo "[MAINTENANCE] gh pr create stdout:"
              cat "$gh_out" || true
              echo "[MAINTENANCE] gh pr create stderr:"
              cat "$gh_err" || true
              if [ $gh_rc -ne 0 ]; then
                echo "[MAINTENANCE][FAIL] gh pr create failed" >&2
              fi

              pr_number="$(gh pr list --head "$branch" --state open --json number --jq '.[0].number' || true)"
              pr_url="$(gh pr list --head "$branch" --state open --json url --jq '.[0].url' || true)"
            fi
          fi

          {
            echo "pr_number=$pr_number"
            echo "pr_url=$pr_url"
            echo "pr_branch=$branch"
            echo "pr_operation=$op"
          } >> "$GITHUB_OUTPUT"

          if [ -z "$pr_number" ]; then
            echo "[MAINTENANCE][FAIL] Working tree was dirty but no PR was created or resolved for branch=$branch operation=$op" >&2
            echo "[MAINTENANCE][FAIL] Most common cause: PR creation blocked by an organization policy or token permissions." >&2
            exit 1
          fi

          echo "[MAINTENANCE] Resolved PR #$pr_number: $pr_url"

      - name: Verify local billing-state bootstrap (headers + ID format)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/ci_verify.py --phase post --billing-state-dir .billing-state

  maintenance_commit:
    name: Maintenance Commit (called)
    needs: maintenance
    if: ${{ needs.maintenance.outputs.pr_number != '' }}
    uses: ./.github/workflows/maintenance_commit.yml
    secrets: inherit
    with:
      pr_number: ${{ needs.maintenance.outputs.pr_number }}

  verify_platform:
    name: Verify Platform (called)
    needs: maintenance
    uses: ./.github/workflows/verify_platform.yml
    secrets: inherit
    permissions:
      contents: read
