name: Maintenance

on:
  push:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure billing-state release + bootstrap local billing-state
        shell: bash
        run: |
          set -euo pipefail
          bash scripts/maintenance_billing_bootstrap.sh

      - name: Regenerate maintenance-state derived indexes
        shell: bash
        run: |
          set -euo pipefail
          python scripts/maintenance_regen_verify_dropdowns.py

      - name: CI verify
        shell: bash
        run: |
          set -euo pipefail
          python scripts/ci_verify.py

      - name: Detect changes (dirty working tree)
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          echo "[MAINTENANCE] git status --porcelain:"
          git status --porcelain || true
          if [ -n "$(git status --porcelain)" ]; then
            echo "[MAINTENANCE] Working tree is DIRTY. PR will be created."
            echo "dirty=true" >> "$GITHUB_OUTPUT"
            echo "[MAINTENANCE] diffstat:"
            git diff --stat || true
          else
            echo "[MAINTENANCE] Working tree is CLEAN. No PR needed."
            echo "dirty=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Ensure label exists: maintenance-auto
        if: steps.detect.outputs.dirty == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          echo "[MAINTENANCE] Ensuring label exists: maintenance-auto"
          if gh label list --json name -q '.[].name' | grep -qx 'maintenance-auto'; then
            echo "[MAINTENANCE] Label already exists: maintenance-auto"
            exit 0
          fi
          gh label create 'maintenance-auto' --color '1D76DB' --description 'Autogenerated maintenance regeneration PRs'
          echo "[MAINTENANCE] Label created: maintenance-auto"

      - name: Create PR (never push to main)
        if: steps.detect.outputs.dirty == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          branch: maintenance/regen-${{ github.run_id }}
          base: main
          title: maintenance: regenerate
          commit-message: maintenance: regenerate
          body: Autogenerated maintenance regeneration.
          labels: |
            maintenance-auto
          delete-branch: false

      - name: Report PR outcome
        if: steps.detect.outputs.dirty == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          echo "[MAINTENANCE] pull-request-operation=${{ steps.cpr.outputs.pull-request-operation }}"
          echo "[MAINTENANCE] pull-request-number=${{ steps.cpr.outputs.pull-request-number }}"
          echo "[MAINTENANCE] pull-request-url=${{ steps.cpr.outputs.pull-request-url }}"

          head_branch="maintenance/regen-${{ github.run_id }}"
          pr_number="${{ steps.cpr.outputs.pull-request-number }}"

          if [ -z "${pr_number}" ]; then
            echo "[MAINTENANCE][WARN] create-pull-request did not return a PR number. Resolving via gh." 
            pr_number="$(gh pr list --state open --base main --head "${head_branch}" --json number -q '.[0].number' || true)"
          fi

          if [ -z "${pr_number}" ]; then
            echo "[MAINTENANCE][FAIL] Working tree was dirty but no PR was created or resolved for head=${head_branch}."
            exit 1
          fi

          pr_url="$(gh pr view "${pr_number}" --json url -q .url)"
          echo "[MAINTENANCE][OK] PR #${pr_number}: ${pr_url}"
