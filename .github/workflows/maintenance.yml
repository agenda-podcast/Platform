name: Maintenance

on:
  workflow_dispatch:
  schedule:
    - cron: "17 3 * * *"

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Maintenance: ensure module prices + generate billing-state seed
        run: |
          python scripts/maintenance_prices_authoritative.py             --modules-dir modules             --repo-prices-path platform/billing/module_prices.csv             --seed-dir platform/billing_state_seed             --default-run-credits 5             --default-save-to-release-credits 2             --report-path runtime/maintenance_prices_report.json

      - name: Verify maintenance seed prices cover all modules
        run: |
          python scripts/ci_verify_prices_seed.py             --modules-dir modules             --seed-path platform/billing_state_seed/module_prices.csv

      - name: Commit maintenance outputs
        run: |
          git status --porcelain
          git add platform/billing/module_prices.csv platform/billing_state_seed/module_prices.csv runtime/maintenance_prices_report.json
          git commit -m "Maintenance: backfill module prices + seed" || echo "No changes"
          git push
