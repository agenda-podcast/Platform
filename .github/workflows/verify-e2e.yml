name: Verify E2E

on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

env:
  BILLING_RELEASE_TAG: billing-state-v1

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup GitHub CLI
        uses: cli/cli@v2
        with:
          version: latest

      - name: Auth GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh auth status

      - name: Download billing-state (read-only for CI)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          mkdir -p .billing-state-ci
          if gh release view "$BILLING_RELEASE_TAG" >/dev/null 2>&1; then
            gh release download "$BILLING_RELEASE_TAG" --dir .billing-state-ci || true
          fi
          # Seed if missing (CI should still be able to run locally)
          for f in tenants_credits.csv transactions.csv transaction_items.csv promotion_redemptions.csv cache_index.csv workorders_log.csv module_runs_log.csv github_releases_map.csv github_assets_map.csv; do
            if [ ! -f ".billing-state-ci/$f" ]; then
              cp "billing-state-seed/$f" ".billing-state-ci/$f"
            fi
          done

      - name: Run Maintenance
        run: |
          python -m platform.cli maintenance

      - name: Verify repo contract (pre)
        run: |
          python scripts/ci_verify.py --phase pre

      - name: Reconcile repo payments into CI billing state
        run: |
          python -m platform.cli reconcile-payments --billing-state-dir .billing-state-ci

      - name: Run orchestrator (CI mode, no GitHub releases)
        run: |
          python -m platform.cli orchestrator --billing-state-dir .billing-state-ci --runtime-dir runtime

      - name: Verify billing-state contract (post)
        run: |
          python scripts/ci_verify.py --phase post --billing-state-dir .billing-state-ci --runtime-dir runtime

      - name: Upload diagnostics (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: verify-e2e-diagnostics
          path: |
            runtime
            .billing-state-ci
            maintenance-state
            platform/billing
            scripts
