# PATCH SNIPPET: Merge into your existing Orchestrator workflow
# Adds decryption of secretstore.json.gpg into runtime/secure/secretstore.json

name: Orchestrator (with Secretstore)

on:
  workflow_dispatch:
  push:

jobs:
  orchestrator:
    runs-on: ubuntu-latest

    # Recommended: use an Environment with required reviewers and store SECRETSTORE_PASSPHRASE there.
    # environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install pyyaml

      - name: Decrypt secretstore
        shell: bash
        env:
          SECRETSTORE_PASSPHRASE: ${{ secrets.SECRETSTORE_PASSPHRASE }}
        run: |
          set -euo pipefail
          bash scripts/secretstore_decrypt_action.sh runtime/secure

      - name: Run orchestrator
        run: |
          python -m platform.cli orchestrator --secretstore runtime/secure/secretstore.json
