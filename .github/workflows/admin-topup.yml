name: Admin Top-Up

on:
  workflow_dispatch:
    inputs:
      tenant_id:
        description: "Tenant ID"
        required: true
        type: string
      amount_credits:
        description: "Credits to add (positive integer)"
        required: true
        type: string
      topup_method_id:
        description: "Top-up method ID (platform/billing/topup_instructions.csv)"
        required: true
        type: string
      reference:
        description: "External reference (bank transfer memo, etc.)"
        required: true
        type: string
      note:
        description: "Optional note"
        required: false
        default: ""
        type: string

permissions:
  contents: write

env:
  BILLING_RELEASE_TAG: "billing-state-v1"

jobs:
  topup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify GitHub CLI
        run: gh --version

      - name: Download billing-state
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p .billing-state
          gh release download "${BILLING_RELEASE_TAG}" -D .billing-state \
            -p "tenants_credits.csv" \
            -p "transactions.csv" \
            -p "transaction_items.csv" \
            -p "promotion_redemptions.csv" \
            -p "cache_index.csv" \
            -p "workorders_log.csv" \
            -p "module_runs_log.csv" \
            -p "state_manifest.json"

      - name: Apply top-up
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -m platform.cli admin-topup \
            --billing-state-dir .billing-state \
            --tenant-id "${{ inputs.tenant_id }}" \
            --amount-credits "${{ inputs.amount_credits }}" \
            --topup-method-id "${{ inputs.topup_method_id }}" \
            --reference "${{ inputs.reference }}" \
            --note "${{ inputs.note }}"

      - name: Upload updated billing-state
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -c "from pathlib import Path; from platform.billing.state import BillingState; BillingState(Path('.billing-state')).write_state_manifest()"
          gh release upload "${BILLING_RELEASE_TAG}" \
            .billing-state/tenants_credits.csv \
            .billing-state/transactions.csv \
            .billing-state/transaction_items.csv \
            .billing-state/promotion_redemptions.csv \
            .billing-state/cache_index.csv \
            .billing-state/workorders_log.csv \
            .billing-state/module_runs_log.csv \
            .billing-state/state_manifest.json --clobber
