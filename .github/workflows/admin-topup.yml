name: Admin Top Up

on:
  workflow_dispatch:
    inputs:
      tenant_id:
        description: "Tenant ID (Base62, length 6)"
        required: true
        type: string
      amount_credits:
        description: "Credits to add (positive integer)"
        required: true
        type: string
      reference:
        description: "Optional reference (defaults to ADMIN_TOPUP:<payment_id>)"
        required: false
        default: ""
        type: string
      note:
        description: "Optional note"
        required: false
        default: ""
        type: string
  workflow_call:
    inputs:
      tenant_id:
        required: true
        type: string
      amount_credits:
        required: true
        type: string
      reference:
        required: false
        type: string
        default: ""
      note:
        required: false
        type: string
        default: ""

permissions:
  contents: write

concurrency:
  group: admin-topup
  cancel-in-progress: false

jobs:
  admin-topup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install Python dependencies (minimal)
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          elif [ -f scripts/requirements.txt ]; then
            python -m pip install -r scripts/requirements.txt
          else
            python -m pip install pyyaml
          fi

      - name: Append Admin Top Up payment record (payments.csv)
        run: |
          set -euo pipefail
          python -m platform.cli admin-topup \
            --tenant-id "${{ inputs.tenant_id }}" \
            --amount-credits "${{ inputs.amount_credits }}" \
            --reference "${{ inputs.reference }}" \
            --note "${{ inputs.note }}"

      - name: Commit + push payments.csv
        run: |
          set -euo pipefail
          bash scripts/ci_commit_push.sh "chore: admin topup tenant=${{ inputs.tenant_id }} credits=${{ inputs.amount_credits }}" "main"

      - name: Ensure billing-state-v1 release exists (bootstrap if missing)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          bash scripts/maintenance_ensure_billing_release.sh

      - name: Hydrate billing-state from GitHub Release (billing-state-v1)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          rm -rf .billing-state
          mkdir -p .billing-state

          if gh release view billing-state-v1 --repo "${GITHUB_REPOSITORY}" >/dev/null 2>&1; then
            echo "Downloading billing-state-v1 assets into .billing-state/ ..."
            gh release download billing-state-v1 --repo "${GITHUB_REPOSITORY}" --dir .billing-state --clobber
          else
            echo "WARNING: billing-state-v1 release not found. Falling back to repo seed .billing-state-ci/."
            cp -a .billing-state-ci/. .billing-state/
          fi

          req=(tenants_credits.csv transactions.csv transaction_items.csv promotion_redemptions.csv workorders_log.csv module_runs_log.csv github_releases_map.csv github_assets_map.csv state_manifest.json)
          for f in "${req[@]}"; do
            if [ ! -f ".billing-state/$f" ]; then
              echo "ERROR: Missing required billing-state file: .billing-state/$f"
              echo "Contents of .billing-state:"
              ls -la .billing-state || true
              exit 2
            fi
          done

      - name: Reconcile payments into billing-state
        run: |
          set -euo pipefail
          python -m platform.cli reconcile-payments --billing-state-dir .billing-state

      - name: Upload updated billing-state assets to GitHub Release (billing-state-v1)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          files=(
            tenants_credits.csv
            transactions.csv
            transaction_items.csv
            promotion_redemptions.csv
            workorders_log.csv
            module_runs_log.csv
            github_releases_map.csv
            github_assets_map.csv
            state_manifest.json
          )

          args=()
          for f in "${files[@]}"; do
            args+=(".billing-state/$f")
          done

          echo "Uploading billing-state-v1 assets (clobber) ..."
          gh release upload billing-state-v1 --repo "${GITHUB_REPOSITORY}" --clobber "${args[@]}"
