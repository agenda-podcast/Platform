name: Orchestrator

on:
  workflow_dispatch:
    inputs:
      work_order_id:
        description: "Work Order ID (platform workorder id)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  orchestrate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Create single workorder index
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import csv
          import os
          from pathlib import Path

          work_order_id = os.environ["WORK_ORDER_ID"]
          out_dir = Path("runtime/orchestrator/single") / work_order_id
          out_dir.mkdir(parents=True, exist_ok=True)
          out_path = out_dir / "workorders_index.single.csv"

          with out_path.open("w", newline="", encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(["tenant_id","work_order_id","path","enabled"])
            w.writerow(["000000", work_order_id, "", "true"])

          print(f"[orchestrator] wrote {out_path}")
          PY
        env:
          WORK_ORDER_ID: ${{ inputs.work_order_id }}

      - name: Bootstrap billing state from release (if needed)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/bootstrap_billing_state_from_release.py             --repo "${GITHUB_REPOSITORY}"             --billing-state-dir ".billing-state"
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run orchestrator
        shell: bash
        run: |
          set -euo pipefail
          python -m platform.cli orchestrator             --work-order-id "${{ inputs.work_order_id }}"

# AUTOGENERATED:PLATFORM_WORKORDERS:BEGIN
- "PlatDb0T"
- "PlatEm0T"
- "PlatWn0V"
# AUTOGENERATED:PLATFORM_WORKORDERS:END
