name: Orchestrator

on:
  workflow_dispatch:
    inputs:
      work_order_id:
        description: "Work Order ID (platform tenant dropdown). Use override to run any ID."
        required: true
        type: choice
        options:
          # AUTOGENERATED:PLATFORM_WORKORDERS:BEGIN
          - "PlatWn0V"
          # AUTOGENERATED:PLATFORM_WORKORDERS:END
      work_order_id_override:
        description: "Manual Work Order ID override (optional, wins if set)"
        required: false
        type: string
  workflow_call:
    inputs:
      work_order_id:
        description: "Work Order ID"
        required: true
        type: string
      work_order_id_override:
        description: "Manual Work Order ID override (optional, wins if set)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi
          if [ -f pyproject.toml ] || [ -f setup.py ]; then
            python -m pip install -e .
          fi

      - name: Resolve work order id
        id: resolve
        run: |
          set -euo pipefail
          if [ -n "${{ inputs.work_order_id_override }}" ]; then
            echo "wo=${{ inputs.work_order_id_override }}" >> "$GITHUB_OUTPUT"
          else
            echo "wo=${{ inputs.work_order_id }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create single-workorder workorders index
        run: |
          set -euo pipefail
          python - <<'PY'
          import csv
          import os
          wo = os.environ["WO"]
          out_dir = os.path.join("runtime", "orchestrator", "single", wo)
          os.makedirs(out_dir, exist_ok=True)
          out_path = os.path.join(out_dir, "workorders_index.single.csv")
          with open(out_path, "w", newline="", encoding="utf-8") as f:
            w = csv.writer(f)
            w.writerow(["tenant_id","work_order_id","path","enabled"])
            w.writerow(["00000t", wo, f"tenants/00000t/workorders/{wo}.yml", "true"])
          print(f"[orchestrator] wrote {out_path}")
          PY
        env:
          WO: ${{ steps.resolve.outputs.wo }}

      - name: Bootstrap billing-state from release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p ".billing-state" "runtime"
          python scripts/bootstrap_billing_state_from_release.py --billing-state-dir ".billing-state"

      - name: Run orchestrator
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          python -m platform.cli orchestrator \
            --work-order-id "${{ steps.resolve.outputs.wo }}" \
            --billing-state-dir ".billing-state" \
            --runtime-dir "runtime/orchestrator"

      - name: Upload runtime evidence zips
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-evidence-zips
          path: .billing-state/runtime_evidence_zips/*

      - name: Publish billing-state release assets
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          python scripts/billing_state_publish.py
