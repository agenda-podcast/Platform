name: Orchestrator

on:
  workflow_dispatch:
    inputs:
      work_order_choice:
        description: Run a single platform workorder (tenant_id=00000t, enabled=true). Select __FULL_QUEUE__ to run the normal full queue.
        required: true
        type: choice
        options:
          - "__FULL_QUEUE__"
          - "__MANUAL__"
          # AUTOGENERATED:PLATFORM_WORKORDERS:BEGIN
          - "PlatDb0T"
          - "PlatEm0T"
          - "PlatWn0V"
          # AUTOGENERATED:PLATFORM_WORKORDERS:END
      work_order_override:
        description: Manual work_order_id override when choice is __MANUAL__
        required: false
        type: string

permissions:
  contents: write   # required for GitHub Releases (gh release create/upload)

concurrency:
  group: orchestrator
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    # IMPORTANT: Environment-scoped secrets (e.g., SECRETSTORE_PASSPHRASE) are only injected
    # when the job explicitly targets that environment.
    environment: Main
    env:
      BILLING_STATE_DIR: .billing-state
      RUNTIME_DIR: runtime
      BILLING_STATE_RELEASE_TAG: billing-state-v1

    steps:
      - uses: actions/checkout@v4

      - name: Capture start time (UTC)
        id: start
        shell: bash
        run: |
          echo "since=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Resolve work_order_id (optional)
        id: wo
        shell: bash
        run: |
          set -euo pipefail
          override="${{ inputs.work_order_override }}"
          choice="${{ inputs.work_order_choice }}"

          if [ -n "${override}" ]; then
            work_order_id="${override}"
          else
            if [ "${choice}" = "__FULL_QUEUE__" ]; then
              work_order_id=""
            elif [ "${choice}" = "__MANUAL__" ]; then
              echo "[orchestrator][FAIL] work_order_override is required when work_order_choice is __MANUAL__" >&2
              exit 2
            else
              work_order_id="${choice}"
            fi
          fi

          echo "work_order_id=${work_order_id}" >> "${GITHUB_OUTPUT}"
          if [ -n "${work_order_id}" ]; then
            echo "[orchestrator] single-workorder mode work_order_id=${work_order_id}"
          else
            echo "[orchestrator] full-queue mode"
          fi

      - name: Prepare runtime dirs
        shell: bash
        run: |
          mkdir -p "${BILLING_STATE_DIR}" "${RUNTIME_DIR}"

      - name: Bootstrap billing-state from GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          python scripts/bootstrap_billing_state_from_release.py \
            --repo "${{ github.repository }}" \
            --tag "${BILLING_STATE_RELEASE_TAG}" \
            --billing-state-dir "${BILLING_STATE_DIR}"

      - name: Scope queue to selected workorder
        if: steps.wo.outputs.work_order_id != ''
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          from pathlib import Path
          import os
          import sys
          
          repo_root = Path('.').resolve()
          if str(repo_root) not in sys.path:
              sys.path.insert(0, str(repo_root))
          
          from platform.workorders.resolver import resolve_workorder_by_id, write_single_workorder_index
          
          work_order_id = os.environ.get('WORK_ORDER_ID', '').strip()
          if not work_order_id:
              raise SystemExit('WORK_ORDER_ID is required')
          
          resolved = resolve_workorder_by_id(repo_root, work_order_id)
          runtime_dir = (repo_root / os.environ.get('RUNTIME_DIR', 'runtime') / 'orchestrator' / 'single' / resolved.work_order_id).resolve()
          runtime_dir.mkdir(parents=True, exist_ok=True)
          
          single_index = runtime_dir / 'workorders_index.single.csv'
          write_single_workorder_index(repo_root, resolved, single_index)
          
          print(f"[orchestrator] wrote single workorders index: {single_index}")
          PY
          echo "PLATFORM_WORKORDERS_INDEX_PATH=${RUNTIME_DIR}/orchestrator/single/${{ steps.wo.outputs.work_order_id }}/workorders_index.single.csv" >> "$GITHUB_ENV"
        env:
          WORK_ORDER_ID: ${{ steps.wo.outputs.work_order_id }}
          RUNTIME_DIR: ${{ env.RUNTIME_DIR }}

      - name: Run orchestrator
        env:
          SECRETSTORE_PASSPHRASE: ${{ secrets.SECRETSTORE_PASSPHRASE }}
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          WORKFLOW_PUSH_TOKEN: ${{ secrets.WORKFLOW_PUSH_TOKEN }}
        shell: bash
        run: |
          python -m platform.cli orchestrator \
            --runtime-profile config/runtime_profile.dev_github.yml \
            --runtime-dir "${RUNTIME_DIR}" \
            --billing-state-dir "${BILLING_STATE_DIR}" \
            --enable-github-releases

      - name: Billing-state tail (this run only)
        if: always()
        shell: bash
        run: |
          if [ -f scripts/billing_state_tail.py ]; then
            python scripts/billing_state_tail.py --billing-state-dir "${BILLING_STATE_DIR}" --since "${{ steps.start.outputs.since }}"
          else
            echo "scripts/billing_state_tail.py not found; skipping tail."
          fi

      - name: Publish billing-state Source of Truth to GitHub Release
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          python scripts/billing_state_publish.py \
            --billing-state-dir "${BILLING_STATE_DIR}" \
            --release-tag "${BILLING_STATE_RELEASE_TAG}" \
            --repo "${{ github.repository }}"
