name: Maintenance Commit

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number to merge (must be labeled maintenance-auto)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - name: Merge maintenance PR (privileged)
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PUSH_TOKEN }}
          PR_NUMBER: ${{ inputs.pr_number }}
        shell: bash
        run: |
          set -euo pipefail

          # Ensure the PR is still open and correctly labeled.
          labels=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name')
          echo "$labels" | grep -qx 'maintenance-auto'

          state=$(gh pr view "$PR_NUMBER" --json state --jq .state)
          if [ "$state" != "OPEN" ]; then
            echo "[MAINTENANCE_COMMIT] PR #$PR_NUMBER is not open (state=$state)."
            exit 0
          fi

          base=$(gh pr view "$PR_NUMBER" --json baseRefName --jq .baseRefName)
          if [ "$base" != "main" ]; then
            echo "[MAINTENANCE_COMMIT] PR #$PR_NUMBER base is $base, expected main."
            exit 0
          fi

          merge_state=$(gh pr view "$PR_NUMBER" --json mergeStateStatus --jq .mergeStateStatus)
          if [ "$merge_state" != "CLEAN" ]; then
            echo "[MAINTENANCE_COMMIT] PR #$PR_NUMBER mergeStateStatus=$merge_state. Not merging."
            exit 0
          fi

          echo "[MAINTENANCE_COMMIT] Merging PR #$PR_NUMBER"
          gh pr merge "$PR_NUMBER" --merge --delete-branch
