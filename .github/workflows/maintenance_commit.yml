name: Maintenance Commit

on:
  workflow_run:
    workflows: ["Maintenance"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Select maintenance-auto PR
        id: select
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PUSH_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "[MAINTENANCE_COMMIT] Searching for open PRs labeled maintenance-auto targeting main"
          pr_number="$(gh pr list --state open --base main --label maintenance-auto --json number,updatedAt,headRefName --jq 'sort_by(.updatedAt) | reverse | map(select(.headRefName | startswith("maintenance/regen-"))) | .[0].number' || true)"
          if [ -z "${pr_number}" ] || [ "${pr_number}" = "null" ]; then
            echo "[MAINTENANCE_COMMIT] No matching PR found. Exiting cleanly."
            echo "pr_number=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "[MAINTENANCE_COMMIT] Selected PR #${pr_number}"
          echo "pr_number=${pr_number}" >> "$GITHUB_OUTPUT"

      - name: Merge maintenance PR (privileged)
        if: steps.select.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PUSH_TOKEN }}
          PR_NUMBER: ${{ steps.select.outputs.pr_number }}
        shell: bash
        run: |
          set -euo pipefail

          state="$(gh pr view "$PR_NUMBER" --json state --jq .state)"
          if [ "$state" != "OPEN" ]; then
            echo "[MAINTENANCE_COMMIT] PR #$PR_NUMBER is not open (state=$state)."
            exit 0
          fi

          base="$(gh pr view "$PR_NUMBER" --json baseRefName --jq .baseRefName)"
          if [ "$base" != "main" ]; then
            echo "[MAINTENANCE_COMMIT] PR #$PR_NUMBER base is $base, expected main."
            exit 0
          fi

          merge_state="$(gh pr view "$PR_NUMBER" --json mergeStateStatus --jq .mergeStateStatus)"
          if [ "$merge_state" != "CLEAN" ]; then
            echo "[MAINTENANCE_COMMIT] PR #$PR_NUMBER mergeStateStatus=$merge_state. Not merging."
            exit 0
          fi

          echo "[MAINTENANCE_COMMIT] Merging PR #$PR_NUMBER"
          gh pr merge "$PR_NUMBER" --merge --delete-branch
